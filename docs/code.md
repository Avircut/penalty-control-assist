# PenaltyControlAssist - Документация для разработчиков

## Содержание
1. [Обзор проекта](#обзор-проекта)
2. [Архитектура приложения](#архитектура-приложения)
3. [Основные компоненты](#основные-компоненты)
   - [Главный модуль (main.py)](#главный-модуль-mainpy)
   - [Контроллер игры (game_controller.py)](#контроллер-игры-game_controllerpy)
   - [Утилиты](#утилиты)
   - [Пользовательский интерфейс](#пользовательский-интерфейс)
4. [Типы данных](#типы-данных)
5. [Конфигурация](#конфигурация)
6. [Алгоритм работы](#алгоритм-работы)
   - [Отслеживание результатов](#отслеживание-результатов)
   - [Запись в таблицу](#запись-в-таблицу)
   - [Управление состоянием игры](#управление-состоянием-игры)
7. [Руководство по разработке](#руководство-по-разработке)
   - [Настройка окружения](#настройка-окружения)
   - [Сборка приложения](#сборка-приложения)
   - [Добавление новых функций](#добавление-новых-функций)
8. [Известные ограничения и планы на будущее](#известные-ограничения-и-планы-на-будущее)

## Обзор проекта

PenaltyControlAssist - это приложение для автоматизации работы режиссеров, использующих vMix при трансляции футбольных матчей с сериями пенальти. Приложение отслеживает результаты ударов на экране, управляет состоянием серии матчей, записывает результаты в Excel-таблицу и отправляет команды в vMix.

![Интерфейс приложения](images/window.png)

### Основные функции:
- Автоматическое отслеживание результатов ударов на экране
- Управление состоянием серии матчей
- Запись результатов в Excel-таблицу
- Логирование результатов
- Автоматическая отправка нажатий клавиш в vMix
- Ручной режим ввода для экстренных ситуаций

## Архитектура приложения

Приложение построено на Python с использованием веб-интерфейса (HTML/CSS/JavaScript). Взаимодействие между фронтендом и бэкендом осуществляется с помощью библиотеки [eel](https://github.com/python-eel/Eel).

### Основные технологии:
- **Python**: Основной язык разработки бэкенда
- **Eel**: Библиотека для создания GUI приложений с использованием веб-технологий
- **OpenCV (cv2)**: Библиотека компьютерного зрения для анализа изображений
- **MSS**: Библиотека для создания скриншотов
- **PyWin32**: Библиотека для взаимодействия с Windows API и Excel
- **HTML/CSS/JavaScript**: Технологии для создания пользовательского интерфейса

### Структура проекта:
```
PenaltyControlAssist/
├── main.py                 # Точка входа в приложение
├── game_controller.py      # Управление состоянием игры
├── cfg_utils.py            # Утилиты для работы с конфигурацией
├── path_utils.py           # Утилиты для работы с путями
├── log_settings.py         # Настройки логирования
├── utils.py                # Общие утилиты
├── type_declarations.py    # Объявления типов данных
├── config.json             # Файл конфигурации
├── build.py                # Скрипт для сборки приложения
├── requirements.txt        # Зависимости проекта
├── ui/                     # Файлы пользовательского интерфейса
│   ├── main.html           # Основной HTML-файл
│   └── css/
│       └── styles.css      # Стили CSS
├── docs/                   # Документация
│   ├── code.md             # Документация для разработчиков
│   └── images/             # Изображения для документации
└── logs/                   # Директория для логов
```

## Основные компоненты

### Главный модуль (main.py)

`main.py` - это точка входа в приложение. Он инициализирует Eel, настраивает веб-интерфейс и содержит основные функции для работы с изображениями и управления состоянием игры.

#### Основные функции:
- `recognize_cells(image)`: Анализирует изображение для определения ячеек с результатами ударов
- `screen_capture()`: Захватывает изображение с экрана и передает его на анализ
- `check_screen(image)`: Проверяет изображение на наличие новых результатов и обновляет состояние игры
- `start_series()`: Начинает новую серию матчей
- `stop_series()`: Останавливает текущую серию матчей
- `series_control()`: Управляет серией матчей
- `start_match()`: Начинает новый матч
- `manually_set_match_state(state)`: Устанавливает состояние матча вручную
- `get_state()`: Возвращает текущее состояние игры для отображения в интерфейсе
- `turn_mode(value, state)`: Переключает режим между автоматическим и ручным

### Контроллер игры (game_controller.py)

`game_controller.py` содержит класс `GameController`, который управляет состоянием игры. Он хранит информацию о текущей серии матчей, игроках, счете и результатах ударов.

#### Основные методы:
- `start_series(player_names)`: Начинает новую серию матчей
- `start_match()`: Начинает новый матч
- `commit_result(result, player_index)`: Записывает результат удара
- `check_game_end(max_kicks)`: Проверяет, закончился ли матч
- `finish_match(match_result)`: Завершает матч
- `finish_series()`: Завершает серию матчей
- `set_status(status)`: Устанавливает статусное сообщение

### Утилиты

#### cfg_utils.py
Содержит функции для работы с конфигурацией:
- `load_config()`: Загружает конфигурацию из файла
- `save_config(data)`: Сохраняет конфигурацию в файл
- `get_config()`: Возвращает текущую конфигурацию

#### path_utils.py
Содержит функции для работы с путями:
- `resource_path(relative_path)`: Возвращает путь к ресурсу (работает как в исходном коде, так и в скомпилированном приложении)
- `get_executable_path(file_name)`: Возвращает путь к файлу относительно исполняемого файла

#### log_settings.py
Настраивает логирование:
- Создает логгер с двумя обработчиками: для отладочных сообщений и для информационных сообщений
- Предоставляет функцию `open_history()` для открытия файла с логами

#### utils.py
Содержит различные утилиты:
- Функции для обработки изображений (`thresholding`, `convert_contours_to_bboxes`, `sort_bboxes`, `cell_check`)
- Функции для работы с Excel (`clear_table`, `write_to_cell`, `write_to_excel`, `check_table_structure`)
- Функции для работы с UI (`show_message`, `get_windows`, `get_monitors`)
- Функции для работы с игрой (`calculate_score`, `extract_teams`, `get_teams`)

### Пользовательский интерфейс

Интерфейс приложения построен с использованием HTML, CSS и JavaScript. Основной файл интерфейса - `ui/main.html`.

#### Основные компоненты интерфейса:
- Настройки (выбор файла, окна vMix, монитора, настройки серии)
- Отображение текущего матча (команды, результаты ударов)
- Переключатель режима (автоматический/ручной)
- Кнопки управления (начать серию, закончить серию, история матчей)
- Статусное сообщение

#### Взаимодействие с бэкендом:
Взаимодействие между фронтендом и бэкендом осуществляется с помощью библиотеки Eel. Функции Python, помеченные декоратором `@eel.expose`, доступны в JavaScript:

```javascript
// Пример вызова Python-функции из JavaScript
const state = await eel.get_state()();
```

## Типы данных

В файле `type_declarations.py` определены типы данных, используемые в приложении:

- `Point`: Точка с координатами x и y
- `Configuration`: Конфигурация приложения
- `CellState`: Состояние ячейки (SUCCESS или FAIL)
- `PlayerState`: Состояние игрока в матче
- `SeriesPlayerState`: Состояние игрока в серии
- `MatchState`: Состояние матча
- `SeriesState`: Состояние серии
- `CVMode`: Режим компьютерного зрения (ON или OFF)
- `MatchResult`: Результат матча (SUSPENDED, DRAW, FIRST_PLAYER, SECOND_PLAYER)

## Конфигурация

Конфигурация приложения хранится в файле `config.json`. Основные параметры:

| Параметр | Тип | Описание | Значение по умолчанию |
|----------|-----|----------|----------------------|
| `hudCoords` | tuple[Point, Point] | Координаты области HUD | `({'x': 1163, 'y': 114}, {'x': 1256, 'y': 154})` |
| `max_kicks` | int | Максимальное количество ударов в матче | `5` |
| `fps` | int | Частота анализа кадров в секунду | `30` |
| `matches_in_series` | int | Количество матчей в серии | `6` |
| `file_path` | str | Путь к таблице для записи результатов | `""` |
| `screen` | str | Номер экрана для захвата | `"1"` |

## Алгоритм работы

### Отслеживание результатов

1. С помощью библиотеки `mss` делаются скриншоты выбранного пользователем экрана с частотой, указанной в конфигурации (параметр `fps`).
2. Из скриншота вырезается область HUD, указанная в конфигурации (параметр `hudCoords`).
3. Область HUD делится на две части: для первого и второго игрока.
4. Каждая часть анализируется с помощью OpenCV:
   - Изображение преобразуется в черно-белое с помощью функции `thresholding`
   - Находятся контуры с помощью `cv2.findContours`
   - Контуры преобразуются в ограничивающие прямоугольники с помощью `convert_contours_to_bboxes`
   - Прямоугольники сортируются слева направо с помощью `sort_bboxes`
   - Для каждого прямоугольника проверяется цвет пикселя внутри с помощью `cell_check`
   - Если цвет близок к зеленому, результат считается успешным (SUCCESS)
   - Если цвет близок к красному, результат считается неудачным (FAIL)
5. Если обнаружены новые результаты, они записываются в состояние игры с помощью `game.commit_result`
6. После записи результата проверяется, закончился ли матч с помощью `game.check_game_end`
7. Если матч не закончился, через 2 секунды отправляется нажатие клавиши Q в окно vMix для запуска таймера

### Запись в таблицу

Запись результатов в Excel-таблицу осуществляется с помощью библиотеки `pywin32`:

1. Открывается Excel-файл, указанный в конфигурации
2. Для каждого игрока записываются результаты ударов в соответствующие ячейки
3. Файл сохраняется

### Управление состоянием игры

Управление состоянием игры осуществляется с помощью класса `GameController`:

1. При начале серии создается новый объект серии с указанными игроками
2. При начале матча создается новый объект матча с игроками, меняющимися местами в каждом матче
3. При каждом ударе результат записывается в состояние игрока и проверяется, закончился ли матч
4. Если матч закончился, обновляется счет серии и начинается новый матч
5. Если серия закончилась (достигнуто максимальное количество матчей), серия завершается

## Руководство по разработке

### Настройка окружения

1. Клонируйте репозиторий
2. Создайте и активируйте виртуальное окружение:
   ```
   python -m venv venv
   venv\Scripts\activate
   ```
3. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

### Сборка приложения

Для создания исполняемого файла используется скрипт `build.py`, который использует PyInstaller:

```
python build.py
```

Это создаст исполняемый файл в папке `dist`.

### Добавление новых функций

#### Добавление функций на бэкенде:
1. Добавьте новую функцию в соответствующий модуль
2. Если функция должна быть доступна из фронтенда, пометьте ее декоратором `@eel.expose`
3. Обновите документацию

#### Добавление функций на фронтенде:
1. Добавьте новый элемент интерфейса в `ui/main.html`
2. Добавьте стили в `ui/css/styles.css`
3. Добавьте обработчики событий в JavaScript-код в `ui/main.html`
4. Для вызова функций бэкенда используйте `eel.<function_name>()`

## Известные ограничения и планы на будущее

### Ограничения:
- Приложение корректно работает только с мониторами с разрешением 1920x1080
- Приложение ожидает определенное расположение HUD на экране
- Приложение может некорректно работать с HUD светлых оттенков

### Планы на будущее:
- Возможность выбора цвета HUD
- Реализация Template Matching с поддержкой ресайза для большей гибкости
- Возможность выгружать логи на какой-то фронт
